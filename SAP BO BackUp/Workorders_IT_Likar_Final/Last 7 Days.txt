SELECT
  SRM_WOI_WORKORDER.Work_Order_ID,
  SRM_WOI_WORKORDER.ASLOGID,
  dbo.fn_adjusted_date(SRM_WOI_WORKORDER.Submit_Date),
  dbo.fn_adjusted_date(SRM_WOI_WORKORDER.Completed_Date) ,
  SRM_WOI_WORKORDER.Summary,
  SRM_WO_PRIORITY.Priority,
  SRM_WO_STATUS.Status,
  SR_WOI_WORKORDER.ASGRP,
  SRM_REQUEST.Region
FROM
  ANA_RPT_OBJECTS_VW,
  (
  SELECT Work_Order_ID,SRID,Summary,CAST(Detailed_Description as nvarchar(MAX)) as Detailed_Description,Company,Submitter,Submit_Date,Last_Modified_By,Last_Modified_Date,Scheduled_Start_Date,Actual_Start_Date,Scheduled_End_Date,Actual_End_Date,InstanceId,ASCPY,ASORG,ASGRP,ASLOGID, Company3 FROM WOI_WORKORDER
WHERE EXISTS
( SELECT DISTINCT 1 FROM CTM_PEOPLE_PERMISSION_GROUPS CTM1
  WHERE CTM1.REMEDY_LOGIN_ID = @VARIABLE('BOUSER')
  AND (( CTM1.COMPANY IS NULL AND PERMISSION_GROUP_ID =  1000000000 )
              OR ( CTM1.COMPANY IS NOT NULL
                      AND CTM1.COMPANY = WOI_WORKORDER.LOCATION_COMPANY )
           )
) AND ( WOI_WORKORDER.SRINSTANCEID IS NOT NULL )

UNION

SELECT Work_Order_ID,SRID,Summary,CAST(Detailed_Description as nvarchar(max)),Company,Submitter,Submit_Date,Last_Modified_By,Last_Modified_Date,Scheduled_Start_Date,Actual_Start_Date,Scheduled_End_Date,Actual_End_Date, InstanceId,ASCPY,ASORG,ASGRP,ASLOGID,Company3 FROM WOI_WORKORDER_ARCHIVE
WHERE EXISTS
( SELECT DISTINCT 1 FROM CTM_PEOPLE_PERMISSION_GROUPS CTM1
  WHERE CTM1.REMEDY_LOGIN_ID = @VARIABLE('BOUSER')
  AND (( CTM1.COMPANY IS NULL AND PERMISSION_GROUP_ID =  1000000000 )
              OR ( CTM1.COMPANY IS NOT NULL
                      AND CTM1.COMPANY = WOI_WORKORDER_ARCHIVE.LOCATION_COMPANY )
           )
) AND ( WOI_WORKORDER_ARCHIVE.SRINSTANCEID IS NOT NULL )
  )  SR_WOI_WORKORDER RIGHT OUTER JOIN (
  SELECT * FROM SRM_REQUEST
WHERE EXISTS
( SELECT DISTINCT 1 FROM CTM_PEOPLE_PERMISSION_GROUPS CTM1
  WHERE CTM1.REMEDY_LOGIN_ID = @VARIABLE('BOUSER')
  AND (( CTM1.COMPANY IS NULL AND PERMISSION_GROUP_ID =  1000000000 )
              OR ( CTM1.COMPANY IS NOT NULL
                      AND ( CTM1.COMPANY = SRM_REQUEST.LOCATION_COMPANY
                                OR CTM1.COMPANY = SRM_REQUEST. CUSTOMER_COMPANY )
                     )
           )
)
  )  SRM_REQUEST ON (SRM_REQUEST.Request_Number=SR_WOI_WORKORDER.SRID)
   LEFT OUTER JOIN (
  SELECT * FROM ANA_WOI_WORKORDER_VW
WHERE EXISTS
( SELECT DISTINCT 1 FROM CTM_PEOPLE_PERMISSION_GROUPS CTM1
  WHERE CTM1.REMEDY_LOGIN_ID = @VARIABLE('BOUSER')
  AND (( CTM1.COMPANY IS NULL AND PERMISSION_GROUP_ID =  1000000000 )
              OR ( CTM1.COMPANY IS NOT NULL
                      AND CTM1.COMPANY = ANA_WOI_WORKORDER_VW.Location_Company )
           )
)
  )  SRM_WOI_WORKORDER ON (SRM_WOI_WORKORDER.SRID=SRM_REQUEST.Request_Number)
   LEFT OUTER JOIN (
  SELECT ENUMID, ENUMVALUE AS STATUS
FROM ANA_SRM_ENUM_VW
WHERE RESOLVED_SCHEMANAME = 'WOI:WorkOrder'
AND FIELDID = 7
  )  SRM_WO_STATUS ON (SRM_WOI_WORKORDER.Status=SRM_WO_STATUS.ENUMID) LEFT OUTER JOIN (
  SELECT ENUMID, ENUMVALUE AS Priority
FROM ANA_SRM_ENUM_VW
WHERE (RESOLVED_SCHEMANAME IN ('WOI:WorkOrder', 'Dummy')
AND FIELDID IN (1000000164, -99))
  )  SRM_WO_PRIORITY ON (SRM_WOI_WORKORDER.Priority=SRM_WO_PRIORITY.ENUMID)
WHERE
  (
   SR_WOI_WORKORDER.ASGRP  IN  ( 'CFS_VAS&Portals_slo','CFS_CRM_slo','CFS_Enterprise Applications_slo','CFS_DMS_slo','CFS_EPI_slo','CFS_FMS_slo','CFS_Wincash_slo'  )
   AND
   dbo.fn_adjusted_date(SRM_WOI_WORKORDER.Submit_Date)  >=  ANA_RPT_OBJECTS_VW.Last_07Days_FNW
  )
